name: branch-merge-guard

on:
  pull_request:

jobs:
  guard:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Enforce branch merge rules
        env:
          BASE: ${{ github.base_ref }}
          HEAD: ${{ github.head_ref }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          fail() {
            local message="$1"

            echo "‚ùå $message"

            gh api repos/$REPO/issues/$PR_NUMBER/comments \
              -f body="üö´ **Merge blocked**\n\n$message"

            exit 1
          }

          echo "PR from '$HEAD' to '$BASE'"

          #
          # BASE: master
          #
          if [[ "$BASE" == "master" ]]; then
            # manual dev flow
            if [[ "$HEAD" =~ ^feat/.* || "$HEAD" =~ ^fix/.* ]]; then
              exit 0
            fi

            # automatic sync
            if [[ "$HEAD" == "rc" ]]; then
              exit 0
            fi

            fail "Into **master** allowed only from **feat/***, **fix/*** or **rc**."
          fi

          #
          # BASE: rc
          #
          if [[ "$BASE" == "rc" ]]; then
            # manual promotion
            if [[ "$HEAD" == "master" ]]; then
              exit 0
            fi

            # automatic sync
            if [[ "$HEAD" == "release" ]]; then
              exit 0
            fi

            fail "Into **rc** allowed only from **master** or **release**."
          fi

          #
          # BASE: release
          #
          if [[ "$BASE" == "release" ]]; then
            if [[ "$HEAD" == "rc" ]]; then
              exit 0
            fi

            fail "Into **release** allowed only from **rc**."
          fi

          #
          # Anything else
          #
          fail "Merging into **$BASE** is not allowed by branch policy."
